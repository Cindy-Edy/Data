<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengingat Canggih</title>
    <!-- Font Awesome 6.0.0 masih relevan -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* CSS DARI KODE ASLI - DITAMBAHKAN BEBERAPA UTILITY CLASS */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(to bottom, #e0ffff, #cce0ff);
        }

        .reminder-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); /* Bayangan lebih halus */
            padding: 30px;
            width: 550px;
            max-width: 90%;
            position: relative; /* Untuk menu */
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 20px;
        }

        /* Styling baru untuk menu/setting */
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .action-button {
            background-color: #5bc0de;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }

        .action-button:hover {
            background-color: #31b0d5;
        }

        .settings-menu {
            position: absolute;
            top: 60px;
            right: 30px;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 10;
            padding: 10px;
            display: none; /* Default hidden */
        }
        
        .settings-menu button {
            display: block;
            width: 100%;
            padding: 8px 15px;
            margin-bottom: 5px;
            text-align: left;
            border: none;
            background: none;
            cursor: pointer;
        }

        .settings-menu button:hover {
            background-color: #f4f4f4;
        }
        /* End of new menu/setting styling */


        .reminder-item {
            background-color: #e0f2f7;
            border-radius: 8px; /* Lebih bulat */
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-wrap: wrap; /* Agar bisa wrap di mobile */
            align-items: center;
            justify-content: space-between;
            transition: background-color 0.3s;
        }

        .reminder-item i {
            color: #42a5f5;
            margin-right: 10px;
            font-size: 1.2em;
        }

        .reminder-text {
            flex-grow: 1;
            margin-right: 15px;
            padding: 5px;
            border-radius: 3px;
            min-width: 150px;
        }
        
        /* Style untuk teks yang sedang diedit */
        .reminder-text[contenteditable="true"] {
            border: 1px solid #42a5f5;
            background-color: #fff;
        }


        .item-actions {
            display: flex;
            gap: 5px;
            margin-left: auto; /* Pindahkan ke kanan */
        }

        .item-actions button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            padding: 5px;
            border-radius: 3px;
        }
        
        .item-actions button:hover {
            background-color: #d1e5ed;
        }

        .close-btn { color: #f44336; }
        .edit-btn { color: #ff9800; }
        .download-btn { color: #4caf50; }


        .add-reminder {
            display: flex;
            margin-top: 25px;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden; /* agar input dan button borderless di dalam box */
        }

        .add-reminder input[type="text"] {
            flex: 2;
            padding: 12px;
            border: none;
        }

        .add-reminder input[type="datetime-local"] {
            flex: 1.5;
            padding: 12px;
            border: none;
            border-left: 1px solid #eee;
        }

        .add-reminder button {
            flex: 0.5;
            background-color: #42a5f5;
            color: white;
            border: none;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .add-reminder button:hover {
            background-color: #2196f3;
        }

        .ringing {
            background-color: #ffcdd2 !important; /* Warna lebih kuat */
            border: 2px solid #e57373;
            animation: blink 0.8s infinite alternate; /* Animasi lebih cepat */
        }

        @keyframes blink {
            0% { background-color: #ef9a9a; }
            100% { background-color: #ffcdd2; }
        }

        footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.8em;
            color: #777;
        }
    </style>
</head>

<body>

    <div class="reminder-container">
        
        <div class="header-controls">
            <h1><i class="fas fa-bell"></i> Pengingat Saya</h1>
            <div>
                <button class="action-button" id="sort-btn" title="Sortir berdasarkan waktu"><i class="fas fa-sort-amount-down"></i> Sortir</button>
                <button class="action-button" id="settings-btn" title="Pengaturan"><i class="fas fa-cog"></i></button>
            </div>
        </div>

        <!-- Menu Pengaturan -->
        <div id="settings-menu" class="settings-menu">
            <button id="delete-all-btn"><i class="fas fa-trash-alt"></i> Hapus Semua Pengingat</button>
            <button id="request-permission-btn"><i class="fas fa-bell"></i> Minta Izin Notifikasi</button>
        </div>
        <!-- Akhir Menu Pengaturan -->

        <div id="reminder-list">
            <!-- Daftar pengingat akan di-load di sini -->
        </div>

        <div class="add-reminder">
            <input type="text" id="new-reminder" placeholder="Teks pengingat...">
            <input type="datetime-local" id="new-reminder-time">
            <button id="add-btn"><i class="fas fa-plus"></i> Tambah</button>
        </div>
    </div>
    </br>
    <div>
        <footer>
            Dibuat oleh Edy Sahputra - Diperbarui dengan Service Worker & Notifikasi
        </footer>
    </div>

    <!-- Gunakan format audio yang lebih umum (mp3/ogg) untuk kompatibilitas yang lebih baik -->
    <audio id="alarmSound" src="https://media.geeksforgeeks.org/wp-content/uploads/20190531135120/siren.mp3" loop></audio> 

    <script>
        // === KONSTAN & ELEMEN DOM ===
        const reminderList = document.getElementById('reminder-list');
        const newReminderInput = document.getElementById('new-reminder');
        const newReminderTimeInput = document.getElementById('new-reminder-time');
        const addButton = document.getElementById('add-btn');
        const alarmSound = document.getElementById('alarmSound');
        const settingsMenu = document.getElementById('settings-menu');
        const settingsBtn = document.getElementById('settings-btn');
        const deleteAllBtn = document.getElementById('delete-all-btn');
        const sortBtn = document.getElementById('sort-btn');
        const requestPermissionBtn = document.getElementById('request-permission-btn');

        // === SERVICE WORKER REGISTRATION (Untuk Background) ===
        // Minta pengguna untuk membuat file service-worker.js
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').then(registration => {
                    console.log('Service Worker terdaftar:', registration);
                }).catch(error => {
                    console.error('Pendaftaran Service Worker gagal:', error);
                    // Beri tahu pengguna jika gagal (biasanya karena file tidak ada)
                    alert('Gagal mendaftarkan Service Worker. Alarm latar belakang tidak akan berfungsi. Pastikan file "service-worker.js" ada.');
                });
            });
        }
        
        // Fungsi untuk meminta izin Notifikasi
        function requestNotificationPermission() {
            if (!("Notification" in window)) {
                alert("Browser ini tidak mendukung notifikasi.");
                return;
            }
            
            Notification.requestPermission().then(permission => {
                alert(`Izin notifikasi: ${permission}`);
                if (permission === 'granted') {
                    // Coba kirim notifikasi percobaan
                    new Notification('Pengingat Aktif!', {
                        body: 'Izin berhasil diberikan. Alarm latar belakang kini bisa berfungsi.',
                        icon: 'https://via.placeholder.com/48/42a5f5/ffffff?text=AI'
                    });
                }
            });
        }
        
        requestPermissionBtn.addEventListener('click', requestNotificationPermission);


        // === FUNGSI UTAMA ===

        // Fungsi untuk merender satu item pengingat
        function createReminderElement(text, time, id) {
            const reminderItem = document.createElement('div');
            reminderItem.classList.add('reminder-item');
            reminderItem.dataset.id = id;
            reminderItem.dataset.time = time || ''; // Simpan waktu di dataset untuk sorting

            const formattedTime = time ? new Date(time).toLocaleString('id-ID', {
                dateStyle: 'short',
                timeStyle: 'short'
            }) : 'Tanpa Waktu';

            reminderItem.innerHTML = `
                <i class="fas fa-clock"></i>
                <span class="reminder-text" contenteditable="false">${text}</span>
                <small class="reminder-time" style="margin-left: 10px; color: #666;">(${formattedTime})</small>
                <div class="item-actions">
                    <button class="edit-btn" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="download-btn" title="Unduh sebagai Gambar"><i class="fas fa-image"></i></button>
                    <button class="close-btn" title="Hapus"><i class="fas fa-times"></i></button>
                </div>
            `;

            // Event Listeners untuk Aksi
            const closeButton = reminderItem.querySelector('.close-btn');
            closeButton.addEventListener('click', () => deleteReminder(reminderItem));

            const editButton = reminderItem.querySelector('.edit-btn');
            editButton.addEventListener('click', () => toggleEdit(reminderItem, editButton));
            
            const downloadButton = reminderItem.querySelector('.download-btn');
            downloadButton.addEventListener('click', () => downloadReminderAsImage(text, time));

            return reminderItem;
        }
        
        // Fungsi untuk menambah pengingat
        function addReminder(text, time) {
            const id = Date.now(); // ID unik
            const reminderItem = createReminderElement(text, time, id);

            reminderList.prepend(reminderItem); // Tambahkan di atas

            saveReminders();
            scheduleAlarm(id, text, time);
        }

        // Fungsi untuk menghapus pengingat
        function deleteReminder(item) {
            const id = item.dataset.id;
            
            // Batalkan alarm jika ada
            clearTimeout(item.timeoutId);
            
            // Hapus dari DOM dan Storage
            item.remove();
            saveReminders();
            
            // Jika sedang berdering, hentikan
            if(item.classList.contains('ringing')) {
                alarmSound.pause();
                alarmSound.currentTime = 0;
            }
        }
        
        // Fungsi untuk mengaktifkan/menonaktifkan mode edit
        function toggleEdit(item, button) {
            const textElement = item.querySelector('.reminder-text');
            const isEditing = textElement.contentEditable === 'true';

            if (isEditing) {
                // Mode Simpan (Selesai Edit)
                textElement.contentEditable = 'false';
                button.innerHTML = '<i class="fas fa-edit"></i>';
                button.title = 'Edit';
                
                // Ambil teks baru dan waktu (waktu tidak bisa diedit inline di sini, tapi bisa diperluas)
                const newText = textElement.innerText;
                
                // Simpan perubahan ke localStorage
                saveReminders();
                
                // Perbarui tampilan waktu dan alarm
                // *CATATAN: Untuk mengedit waktu, perlu menambahkan input datetime-local saat mode edit
            } else {
                // Mode Edit
                textElement.contentEditable = 'true';
                textElement.focus();
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.title = 'Simpan';
            }
        }

        // Fungsi Alarm Lokal (Hanya bekerja jika tab aktif)
        function scheduleAlarm(id, text, time) {
            if (!time) return;

            const reminderTime = new Date(time);
            const now = new Date();
            
            if (reminderTime <= now) return; // Abaikan jika sudah lewat

            const timeDiff = reminderTime.getTime() - now.getTime();
            const reminderItem = document.querySelector(`.reminder-item[data-id="${id}"]`);

            const timeoutId = setTimeout(() => {
                // Alarm UI Lokal (berfungsi jika tab aktif)
                if (reminderItem) {
                    reminderItem.classList.add('ringing');
                }
                alarmSound.play().catch(e => console.error("Gagal memutar alarm:", e));

                // Hentikan alarm setelah 10 detik
                setTimeout(() => {
                    if (reminderItem) {
                        reminderItem.classList.remove('ringing');
                    }
                    alarmSound.pause();
                    alarmSound.currentTime = 0;
                }, 10000);
            }, timeDiff);

            if (reminderItem) {
                reminderItem.timeoutId = timeoutId; // Simpan ID timeout
            }
            
            // Coba kirim pesan ke Service Worker untuk Notifikasi Latar Belakang
            if ('serviceWorker' in navigator && Notification.permission === 'granted') {
                 navigator.serviceWorker.ready.then(registration => {
                    // Kirim data alarm ke service worker
                    registration.active.postMessage({
                        action: 'scheduleAlarm',
                        id: id,
                        text: text,
                        time: time,
                        delay: timeDiff // Waktu dalam ms dari sekarang
                    });
                });
            }
        }
        
        // Fungsi Sortir
        function sortReminders() {
            const reminders = Array.from(document.querySelectorAll('.reminder-item'));

            reminders.sort((a, b) => {
                const timeA = new Date(a.dataset.time || '9999-12-31T23:59').getTime();
                const timeB = new Date(b.dataset.time || '9999-12-31T23:59').getTime();

                // Sortir dari waktu terdekat (paling kecil) ke waktu terjauh
                return timeA - timeB; 
            });

            // Render ulang
            reminderList.innerHTML = '';
            reminders.forEach(item => reminderList.appendChild(item));
        }

        // === PERSISTENSI (LOCAL STORAGE) ===

        function saveReminders() {
            const reminders = [];
            document.querySelectorAll('.reminder-item').forEach(item => {
                const text = item.querySelector('.reminder-text').innerText;
                const time = item.dataset.time; // Ambil dari dataset

                reminders.push({
                    text,
                    time
                });
            });
            localStorage.setItem('reminders', JSON.stringify(reminders));
        }

        function loadReminders() {
            const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
            reminders.forEach(reminder => addReminder(reminder.text, reminder.time));
            sortReminders(); // Sortir setelah load
        }


        // === LISTENERS & INISIALISASI ===

        // Inisialisasi: Load pengingat yang tersimpan
        loadReminders();

        // Listener Tombol Tambah
        addButton.addEventListener('click', () => {
            const newReminderText = newReminderInput.value.trim();
            const newReminderTime = newReminderTimeInput.value;

            if (newReminderText !== "") {
                addReminder(newReminderText, newReminderTime);
                newReminderInput.value = "";
                newReminderTimeInput.value = "";
            } else {
                alert('Teks pengingat tidak boleh kosong.');
            }
        });

        // Listener Tombol Pengaturan
        settingsBtn.addEventListener('click', () => {
            settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
        });
        
        // Listener Tombol Sortir
        sortBtn.addEventListener('click', sortReminders);
        
        // Listener Tombol Hapus Semua
        deleteAllBtn.addEventListener('click', () => {
            if (confirm('Anda yakin ingin menghapus SEMUA pengingat?')) {
                localStorage.removeItem('reminders');
                reminderList.innerHTML = '';
                alarmSound.pause();
                alarmSound.currentTime = 0;
                alert('Semua pengingat telah dihapus.');
                settingsMenu.style.display = 'none';
            }
        });


        // === FUNGSI UNDUH (Dipertahankan dari kode asli) ===
        function downloadReminderAsImage(text, time) {
            // Menggunakan html2canvas akan lebih baik, tapi ini menggunakan Canvas API dasar
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 400;
            canvas.height = 200; 
            context.fillStyle = '#e0f2f7';
            context.fillRect(0, 0, canvas.width, canvas.height);
            context.font = '24px Segoe UI';
            context.fillStyle = '#333';
            context.textAlign = 'center';
            context.fillText(text, canvas.width / 2, 80);

            if (time) {
                const reminderTime = new Date(time);
                const formattedTime = reminderTime.toLocaleString('id-ID');

                context.font = '16px Segoe UI';
                context.fillText(`Waktu: ${formattedTime}`, canvas.width / 2, 130);
            }

            const imageURL = canvas.toDataURL('image/png'); // Gunakan PNG untuk kualitas yang lebih baik
            const downloadLink = document.createElement('a');
            downloadLink.href = imageURL;
            downloadLink.download = `pengingat_${text.replace(/\s+/g, '_')}.png`; 
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    </script>

</body>

</html>
